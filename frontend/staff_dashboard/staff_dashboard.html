<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - SyntaxSchoolers</title>
    <link rel="stylesheet" href="/staff_dashboard/staff_dashboard.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="menu-title">Menu:</div>
        <div class="nav-item active" onclick="showDashboard()">Home</div>
        <div class="nav-item" onclick="logout()">Logout</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Teacher Dashboard</h1>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card" onclick="openModal('current-words')">
                <div>Current Word<br>List</div>
            </div>
            <div class="dashboard-card" onclick="openModal('edit-words')">
                <div>Edit Word List</div>
            </div>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Modal Title</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/staff';
        let currentCategories = [];

        // Modal Management
        function openModal(type) {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            switch(type) {
                case 'current-words':
                    title.textContent = 'Current Word List';
                    content.innerHTML = getCurrentWordsContent();
                    loadCategoriesForEdit();  // Load categories for the dropdown
                    loadCurrentWords();
                    break;
                case 'edit-words':
                    title.textContent = 'Edit Word List';
                    content.innerHTML = getEditWordsContent();
                    loadCategoriesForEdit();
                    break;
            }
            
            overlay.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function showDashboard() {
            closeModal();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/login.html';
            }
        }

        // Modal Content Templates
        function getCurrentWordsContent() {
            return `
                <div class="form-section">
                    <h3>Filter Words</h3>
                    <label>Category:</label>
                    <select id="filter-category">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn" onclick="loadCurrentWords()">Refresh</button>
                </div>
                <div id="words-display"></div>
            `;
        }

        function getEditWordsContent() {
            return `
                <div class="form-section">
                    <h3>Categories Management</h3>
                    <input type="text" id="new-category-name" placeholder="New category name">
                    <button class="btn" onclick="createCategory()">Add Category</button>
                    <div id="categories-list"></div>
                </div>
                <div id="add-category-results" class="results" style="display: none;"></div>
                <div class="form-section">
                    <h3>Add New Word</h3>
                    <input type="text" id="new-english" placeholder="English word">
                    <input type="text" id="new-french" placeholder="French word">
                    <select id="new-word-category">
                        <option value="">Select Category</option>
                    </select>
                    <button class="btn" onclick="createWord()">Add Word</button>
                    <div id="add-word-results" class="results" style="display: none;"></div>
                </div>
                
                <div class="form-section">
                    <h3>Edit/Delete Words</h3>
                    <input type="number" id="edit-word-id" placeholder="Enter word ID">
                    <button class="btn btn-secondary" onclick="loadWordForEdit()">Load Word</button>
                    <button class="btn btn-danger" onclick="deleteWord()">Delete</button>
                    
                    <div id="edit-word-form" style="display: none; margin-top: 10px;">
                        <input type="text" id="edit-english" placeholder="English">
                        <input type="text" id="edit-french" placeholder="French">
                        <input type="number" id="edit-category-id" placeholder="Category ID">
                        <button class="btn" onclick="updateWord()">Update Word</button>
                    </div>
                </div>
                
                <div id="edit-results" class="results" style="display: none;"></div>
            `;
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                return await response.json();
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function loadCurrentWords() {
            const category = document.getElementById('filter-category')?.value || '';
            const endpoint = category ? `/vocab?category=${category}` : '/vocab';
            
            const data = await apiCall(endpoint);
            if (data.success) {
                const wordsData = Array.isArray(data.data) ? 
                    { words: data.data, totalCount: data.data.length, currentPage: 1, totalPages: 1 } : 
                    data.data;
                displayWordsTable(wordsData);
            } else {
                showResult('words-display', data, true);
            }
        }

        async function loadCategoriesForEdit() {
            const data = await apiCall('/categories');
            if (data.success) {
                currentCategories = data.data;
                populateSelects();
                displayCategoriesList();
            }
        }

        async function createCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            if (!name) return alert('Please enter a category name');

            const data = await apiCall('/categories', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoryName: name })
            });
            
            if (data.success) {
                document.getElementById('new-category-name').value = '';
                loadCategoriesForEdit();
                showResult('add-category-results', 'Success');
            } else {
                showResult('add-category-results', data, true);
            }
        }

        async function createWord() {
            const english = document.getElementById('new-english').value.trim();
            const french = document.getElementById('new-french').value.trim();
            const categoryId = document.getElementById('new-word-category').value;

            if (!english || !french || !categoryId) return alert('Please fill in all fields');

            const data = await apiCall('/vocab', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    lang1Word: english, 
                    lang2Word: french, 
                    categoryId: parseInt(categoryId) 
                })
            });
            
            if (data.success) {
                ['new-english', 'new-french', 'new-word-category'].forEach(id => 
                    document.getElementById(id).value = ''
                );
                showResult('add-word-results', 'Success');
            } else {
                showResult('add-word-results', data, true);
            }
        }

        async function loadWordForEdit() {
            const wordId = document.getElementById('edit-word-id').value;
            if (!wordId) return alert('Please enter a word ID');

            const data = await apiCall(`/vocab/${wordId}`);
            if (data.success) {
                const word = data.data;
                document.getElementById('edit-english').value = word.lang1_word;
                document.getElementById('edit-french').value = word.lang2_word;
                document.getElementById('edit-category-id').value = word.category_id;
                document.getElementById('edit-word-form').style.display = 'block';
            } else {
                showResult('edit-results', data, true);
            }
        }

        async function updateWord() {
            const wordId = document.getElementById('edit-word-id').value;
            const english = document.getElementById('edit-english').value.trim();
            const french = document.getElementById('edit-french').value.trim();
            const categoryId = document.getElementById('edit-category-id').value;

            if (!wordId || !english || !french || !categoryId) return alert('Please fill in all fields');

            const data = await apiCall(`/vocab/${wordId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    lang1Word: english, 
                    lang2Word: french,
                    categoryId: parseInt(categoryId)
                })
            });
            
            if (data.success) {
                document.getElementById('edit-word-form').style.display = 'none';
                document.getElementById('edit-word-id').value = '';
                showResult('edit-results', 'Success');
            } else {
                showResult('edit-results', data, true);
            }
        }

        async function deleteWord() {
            const wordId = document.getElementById('edit-word-id').value;
            if (!wordId) return alert('Please enter a word ID');
            if (!confirm('Are you sure you want to delete this word?')) return;

            const data = await apiCall(`/vocab/${wordId}`, { method: 'DELETE' });
            if (data.success) {
                document.getElementById('edit-word-id').value = '';
                document.getElementById('edit-word-form').style.display = 'none';
                showResult('edit-results', 'Success');
            } else {
                showResult('edit-results', data, true);
            }
        }

        // Helper Functions
        function displayWordsTable(data) {
            const container = document.getElementById('words-display');
            const selectedCategory = document.getElementById('filter-category')?.value || '';
            const showCategoryColumn = !selectedCategory;
            
            const headerText = data.totalPages > 1 ? 
                `Words (Page ${data.currentPage} of ${data.totalPages}) - Total: ${data.totalCount}` : 
                `All Words - Total: ${data.totalCount}`;
            
            container.innerHTML = `
                <h4>${headerText}</h4>
                <table class="word-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>English</th>
                            <th>French</th>
                            ${showCategoryColumn ? '<th>Category</th>' : ''}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.words.map(word => `
                            <tr>
                                <td>${word.vocab_id}</td>
                                <td>${word.lang1_word}</td>
                                <td>${word.lang2_word}</td>
                                ${showCategoryColumn ? `<td>${word.category_name}</td>` : ''}
                                <td>
                                    <button class="btn action-btn" onclick="openModal('edit-words'); setTimeout(() => { document.getElementById('edit-word-id').value = ${word.vocab_id}; loadWordForEdit(); }, 100)">Edit</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function displayCategoriesList() {
            const container = document.getElementById('categories-list');
            container.innerHTML = `
                <h4>Current Categories:</h4>
                <ul>
                    ${currentCategories.map(cat => `<li>${cat.category_name} (${cat.word_count} words)</li>`).join('')}
                </ul>
            `;
        }

        function populateSelects() {
            ['filter-category', 'new-word-category', 'edit-word-category'].forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const firstOption = select.children[0];
                    select.innerHTML = '';
                    select.appendChild(firstOption);
                    currentCategories.forEach(cat => {
                        select.add(new Option(cat.category_name, cat.category_id));
                    });
                }
            });
        }

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `results ${isError ? 'error' : 'success'}`;
                element.style.display = 'block';
                if (typeof data === 'string') {
                    element.textContent = data;
                } else {
                    element.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
            }
        }

        // Event Listeners
        document.getElementById('modalOverlay').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeModal();
        });

        // Initialise
        window.addEventListener('load', async () => {
            const data = await apiCall('/categories');
            if (data.success) currentCategories = data.data;
        });
    </script>
</body>
</html>